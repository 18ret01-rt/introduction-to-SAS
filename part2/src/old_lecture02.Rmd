---
title: "Importing a wide range of data formats"
author: "Steve Simon"
date: "7/1/2019"
output: powerpoint_presentation
---


```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, comment="")
suppressMessages(suppressWarnings(library(dplyr)))
suppressMessages(suppressWarnings(library(knitr)))
suppressMessages(suppressWarnings(library(magrittr)))
```

### Categorical data
+ proc format
+ recoding
+ proc freq
+ barcharts

<div class="notes">

We're going to look at a different data set, one with mostly categorical variables. I'll introduce proc format, which allows you to attach labels to categorical data, talk about recoding, and show some tables using proc freq. I'll also show you a simple bar chart.

</div>

### Titanic data set

```{r lecture02.sas}
program_name <- opts_current$get("label") 
program_name %>%
  readLines(warn=FALSE) -> sas_code
input_source_line <- grep("filename raw_data", sas_code) + 1
sas_code[input_source_line] %>%
  substr(4, 999) %>%
  sub("\";", "", .) %>% 
  readLines(n=10) %>%
  paste0(collapse="\n") %>%
  cat
sas_code %>% 
  grep("********* *********", ., fixed=TRUE) -> comment_lines
k <- (length(comment_lines)-1) %/% 2

ppt_head <- rep(" ", k)
ppt_note <- rep(" ", k)
ppt_code <- rep(" ", k)
for (i in 1:k) {
  ppt_head[i] <- paste0("### ", sas_code[comment_lines[2*i-1] + 1])
  ppt_note[i] <- paste0(sas_code[(comment_lines[2*i-1]+3):(comment_lines[2*i]  -1)], collapse="\n")
  ppt_code[i] <- paste0(sas_code[(comment_lines[2*i]  +2):(comment_lines[2*i+1]-2)], collapse="\n")
}
```

`r ppt_head[1]`

```{r}
cat(ppt_code[1])
```

<div class="notes">

`r ppt_note[i]

</div>

### Preliminaries

```{r lecture02-1}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
header    <-  comment_lines[2*i-1]+1)
section_a <- (comment_lines[2*i-1]+3):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### proc import

```{r lecture02-2}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>


### Print first ten rows

```{r lecture02-3}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### First ten rows of the Titanic data set

![Proc print output](../images/lecture02-0`r j<- 1; j`.png)

<div class="notes">



</div>

### Simple frequency counts

```{r lecture02-4}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Frequency tables for PClass and Sex

![Proc freq output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### Frequency tables for Survived

![Proc freq output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### Recode age to numeric

```{r lecture02-5}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Means for age

![Proc means output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### Add labels to Survived

```{r lecture02-6}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Improved frequency tables for Survived

![Proc freq output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### SAS code for a bar chart

```{r lecture02-7}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Bar chart, counts

![Proc sgplot output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### SAS code to create percentages

```{r lecture02-8}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### New data set output from proc freq

![Proc print output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### Bar chart, percentages

![Proc print output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### SAS code for two way crosstabulation

```{r lecture02-9}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Crosstabulation of Survived by Sex

![Proc print output](../images/lecture02-0`r j<- j+1; j`.png)

<div class="notes">



</div>

### SAS code to create age categories

```{r lecture02-10}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Use a crosstabulation as a quality check

```{r lecture02-11}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>


### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Quality check for age_cat (`r j-8` of 9)

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### Use a crosstabulation as a quality check

```{r lecture02-12}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Then add labels

```{r lecture02-13}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Improved quality check for age_cat

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

### SAS code to collapse categories

```{r lecture02-14}
opts_current$get("label") %>%
  sub("^.*-", "", .) %>%
  as.numeric -> i
section_a <- (comment_lines[2*i-1]+1):(comment_lines[2*i]-1)
section_b <- (comment_lines[2*i]+2):(comment_lines[2*i+1]-2)
cat(sas_code[section_b], sep="\n")
```

<div class="notes">

`r paste0(sas_code[section_a], collapse="\n")`

</div>

### Quality check for first class recode

![Proc freq output](../images/lecture02-`r j<- j+1; j`.png)

<div class="notes">



</div>

